# Polygenic Risk Score Estimation with LDpred and PLINK

## Software Requirements

This procedure requires LDpred and PLINK (Version 1 *and* 2) to be installed.
They're installed on all UPPMAX systems and you can load them like this:

```
module add \
  bioinfo-tools \
  LDpred/1.0.8 \
  plink/1.90b4.9 \
  plink2/2.00-alpha-2-20190429
```

Furthermore, the following R packages should be installed:

* data.table
* magrittr
* stringr

They are available in the `R_packages` module on UPPMAX.

All scripts are provided as separate Slurm and R files but they need some customization for your specific use-case.
I make heavy use of Slurm Job Arrays to parallelize the operations.
If you aren't familiar with them, the [documentation on the slurm website](https://slurm.schedmd.com/job_array.html) is pretty good.

## Directory Structure
This manual and all scripts assume the following directory structure:

```
.
├── coordination
├── genotypes
│   ├── chr1.bed
│   ├── chr1.bim
│   ├── chr1.dedup.bim
│   └── ...
├── gwas
├── ld
├── mfi
│   ├── _004_ukb_mfi_chr1_v3.txt
│   ├── _004_ukb_mfi_chr2_v3.txt
│   └── ...
├── reference_genotypes
├── sample_info
│   ├── estimation.ids
│   ├── samples.fam
│   └── validation.ids
├── scores
└── weights
```

Where all directories are *empty*, except for:

* `genotypes` containing all your plink genotype/SNP data
* `sample_info` for your fam files and ID lists of your cohorts for LD-pattern estimation and validation,
* `mfi` containing MAF and imputation quality information

You can use [`make_dirs`](make_dirs) to create all the empty directories in one step.
I recommend creating the non-empty directories as symlinks to the shared locations holding all your required data.

## GWAS
Run a GWAS on the trait you are interested in.
The procedure will not be discussed furthere.
However, you should restrict your association study to genotyped SNPs.
This will greatly reduce the necessary computing power and speed up the process of calculating LD patterns and scores while delivering results comparable with imputed data.

## Preparing the LD Estimation

### Formatting your GWAS Summary
LDpred requires a GWAS summary.
It accepts a range of formats.
However, all of them are different from the one generated by Plink.
We use the file format which was the default in the LDpred beta releases, called `STANDARD`.

It is as follows:

```
chr pos ref alt reffrq info rs pval effalt
```

Where:

* `chr` is the SNP's chromosome
* `pos` is the SNP's base pair
* `ref` is the effective allele (i.e. A1)
* `alt` is the non-effective allele (i.e. A2)
* `reffrq` is the frequency of the **reference** allele
* `info` is the imputation quality as info score
* `rs` is the rs ID
* `pval` is the SNP's P value
* `effalt` is the beta value

*Note*: If you use any version of LDpred before 1.0.0, the info score is ignored and you can safely set it to 1.

You can find all the necessary steps in [`LDpred_formatting.R`](LDpred_formatting.R).

While you are at it: This is the perfect moment to filter for imputation quality.
Subset your data by INFO score and save the passing rs IDs to a file (referred to as `info_snps.txt` below).

### Extracting the Reference Dataset
#### Subsetting Individuals
LDpred uses a reference dataset in order to compute the LD pattern.
A good option is to use 5000 random non-related individuals.
You can extract this kind of set with the following command:

```
shuf -n 5000 sample_info/samples.fam > sample_info/estimation.ids
```

LDpred works on Plink 1 binary (i.e. bed/bim/fam) files.
Therefore, we need to extract the individuals' genotypes and save them to BED files.

Please see [`extract.slurm`](extract.slurm) for the extraction script.

#### Merging the Genotyping Data
The resulting bed files must be merged into one.
Unfortunately, Plink 2 doesn't support merging, yet, so we must do it with Plink 1.
Once merging is implemented in version 2, this step can be combined with the one above into one step.

First, you must create a list of all data sets to be merged.
You can use [`create_merge_list.R`](create_merge_list.R) for that.

Please see [`merge.slurm`](merge.slurm) for the merging script.

## Genotype Coordination
The first step of your LDpred analysis is the coordination of your genotyping data and GWAS summary.

Please see [`coord.slurm`](coord.slurm) for the appropriate script.
Before submitting a job you *must* adjust parameter `N`, which is the number of individuals in your GWAS.

**Important:** If the coordination fails and you want to restart it, remove the file `coordination/coordination.coord` first.
Otherwise the job will fail, again.

## Estimating SNP weights
After the coordination is done, you can estimate SNP weights.
Please see [`estimate_weights.slurm`](estimate_weights.slurm) for a template.
The call has two parameters which need adjustment:

* `N`: The number of individuals in your GWAS (analogous to the coordination step)
* `ldr`: The LD radius, i.e. the number of SNPs around the focal SNP which LD should be adjusted for. Recommended value: $\frac{S}{3000}$, where $S$ is the number of total SNPs in your GWAS.

**Performance Considerations:**
This step is computationally expensive.
See the following table to get an idea about the necessary power and time:

| Data set       |    # SNPs | LD radius | RAM (GB) | Computing Time |
|----------------|----------:|----------:|---------:|----------------|
| Imputed        | 8,939,991 |     2,900 |      280 | 5 days         |
| Genotyped only |   770,240 |       260 |       11 | 40 minutes     |
| **Ratios**     |  **11.6** |  **11.6** | **25.5** | **180**        |

The optional parameter `f` is used to specify the fraction of variants assumed to be causal by LDpred's sampler.
It defaults to `1 0.1 0.01 0.001 0.3 0.03 0.003 inf`.
Specifying `inf` causes LDpred to use a different estimation weighting algorithm [1].


There are many additional arguments you can tinker with.
It's best to check the documentation using

```
ldpred gibbs --help
```

The LD pattern is saved to a file named `<ldf>_ldradius<ldr>.pkl.gz` in directory `ld`.
This file can be reused across analyses which use the same LD radius.
If it doesn't exist, it will be created, which may take several hours.

## Calculating Your Scores
### Scoring Individual Chromosomes, Models
After LDpred has finished estimation LD and SNP weights, it's time to finally compute polygenic risk scores.
I did it with plink but this functionality is offered by LDpred, as well.
However, both tools use different algorithms, so do not expect the results to be the same.

Because genotyping files are split by chromosome, scores must be calculated separately for each of them.
The results are then summed up for each individual.
The script [`score.slurm`](score.slurm) can be used to submit the calculation for each chromosome and assumed fraction of causal SNPs.
If you used default parameters in all preceding steps, you needn't change anything.
However, if you modified the assumed fractions, the range of array job indexes must be adjusted.
You need $J = F * C$ jobs, where $F$ is the number of fractions passed as parameter `f` and $C$ the number of chromosomes.
The index range you specify in your slurm script must run from 0 to $J-1$ (default: 0-175).

*Note:* This will spawn *a lot* of relatively short jobs, which will probably clog up your queue.
You should warn your colleagues beforehand in case they need to submit urgent tasks to the cluster.

*Note:* Each task is single-threaded and can run on a single core, making very efficient use of your resources.
However, having 16 different processes running on the same node incurs heavy performance penalties (Cache misses, IO controller saturation) and therefore increases run time.
This is why the default script uses two cores per task.

### Merging Scores
The scoring jobs generate a lot of files.
In this step we will merge them into one single table which you can work with.
See [`merge_scores.R`](merge_scores.R) for a script. 

## See also
* [LDpred GitHub Repository](https://github.com/bvilhjal/ldpred)

## References
[1]: Vilhjálmsson, B. J., Yang, J., Finucane, H. K., Gusev, A., Lindström, S., Ripke, S., … Price, A. L. (2015). Modeling Linkage Disequilibrium Increases Accuracy of Polygenic Risk Scores. American Journal of Human Genetics, 97(4), 576–592. https://doi.org/10.1016/j.ajhg.2015.09.001